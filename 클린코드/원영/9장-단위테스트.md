# 9장 단위 테스트

### TDD 법칙 세 가지

- TDD가 실제 코드를 짜기 전에 단위 테스트부터 짜라고 요구한다
- 위 요구는 빙산의 일각에 불과하다. 아래 세 가지 법칙을 살펴보자.
    - 첫째 법칙 :  실패하는 단위 테스트를 작성할 때까지 실제 코드를 작성하지 않는다.
    - 둘째 법칙 : 컴파일은 실패하지 않으면서 실행이 실패하는 정도로만 단위 테스트를 작성한다.
    - 셋째 법칙 : 현재 실패하는 테스트를 통과할 정도로만 실제 코드를 작성한다.
- 이렇게 하면 실제 코드를 사실상 전부 테스트하는 테스트 케이스가 나온다.
- 하지만 실제 코드와 맞먹을 정도로 방대한 테스트 코드는 심각한 관리 문제를 유발하기도 한다.

### 깨끗한 테스트 코드 유지하기

- 테스트 코드가 지저분하면 실제 코드 변경시 실제 코드를 짜는 시간보다 테스트 케이스 수정이 더 오래 걸린다.
- 테스트 코드는 실제 코드 못지 않게 중요하다.
- **테스트 코드는 사고와 설계와 주의가 필요하다. 실제 코드 못지 않게 깨끗하게 짜야 한다.**

### 테스트는 유연성, 유지보수성, 재사용성을 제공한다

- 코드에 유연성, 유지보수성, 재사용성을 제공하는 버팀목이 바로 단위 테스트다.
- 테스트 케이스가 없다면 모든 변경은 잠정적인 버그다.
- 테스트 코드가 지저분할수록 실제 코드도 지저분해진다. 결국 테스트 코드를 잃어버리고 실제 코드도 망가진다.

### 깨끗한 테스트 코드

- 깨끗한 테스트 코드에서는 가독성이 가장 중요하다.
- 깨끗한 코드를 위해서는 명료성, 단순성, 풍부한 표현력이 필요하다.
- 각 테스트는 명확히 세 부분으로 나눠라.
    - 첫 부분 : 테스트 자료를 만든다.
    - 두 번째 부분 : 테스트 자료를 조작
    - 세 번째 부분 : 조작한 결과가 올바른지 확인
- 위와 같은 방식으로 작성하면 코드를 읽는 사람은 온갖 잡다하고 세세한 코드에 헷갈릴 필요 없이 코드가 수행하는 기능을 재빨리 이해한다.

### 이중 표현

- 테스트 API코드에 적용하는 표준은 단순하고, 간결하고, 표현력이 풍부해야 하지만, 실제 코드만큼 효율적일 필요는 없다.
- 실제 환경이 아니라 테스트 환경에서 돌아가는 코드이기 때문인데, 실제 환경과 테스트 환경은 요구사항이 판이하게 다르다.

```java
@Test
public void turnOnLoTempAlarmAtThreashold() throws Exception {
  hw.setTemp(WAY_TOO_COLD);
  controller.tic();
  assertTrue(hw.heaterState());
  assertTrue(hw.blowerState());
  assertFalse(hw.coolerState());
  assertFalse(hw.hiTempAlarm());
  assertTrue(hw.loTempAlarm());
}
```

위 코드를 리펙토링 하면

```java
@Test
public void turnOnLoTempAlarmAtThreshold() throws Exception {
  wayTooCold();
  assertEquals("HBchL", hw.getState());
}
```

- 대문자는 ‘켜짐’, 소문자는 ‘꺼짐’을 뜻한다.
- 일단 의미만 안다면 눈길이 문자열을 따라 움직이며 결과를 재빨리 판단한다. 테스트 코드를 읽기가 사뭇 즐거워진다.

### 테스트 당 assert 하나

- assert가 하나라면 결론이 하나기 때문에 코드를 이해하기 빠르고 쉽다.
- 하지만, 테스트를 분리하여 중복되는 코드가 많아지는 경우는 차라리 assert문을 여러개 사용하는 편이 좋다.
- 결론은 최대한 assert 문 개수는 최대한 줄여야 좋다고 생각한다.

### 테스트당 개념 하나

- 이것저것 잡다한 개념을 연속으로 테스트하는 긴 함수는 피한다.
- 여러 개념을 한 함수에 몰아넣으면 독자가 각 절이 거기에 존재하는 이유와 각 절이 테스트하는 개념을 모두 이해해야 한다.
- 한 테스트 함수에서 여러 개념을 테스트하면 안된다.
- 따라서 가장 좋은 규칙은 “개념 당 assert 문 수를 최소로 줄여라” 와 “테스트 함수 하나는 개념 하나만 테스트하라”이다.

### F.I.R.S.T

깨끗한 테스트는 다음 다섯 가지 규칙을 따른다.

- F (Fast)
    - 테스트는 빨라야 한다.
    - 테스트가 느리면 자주 돌릴 엄두가 안난다.
    - 자주 돌리지 않으면 초반에 문제를 찾아내 고치지 못한다
    - 결국 코드의 품질이 망가지기 시작한다.
- I (Independent)
    - 각 테스트는 서로 의존하면 안된다.
    - 독립적이므로 어떤 순서로 실행해도 괜찮아야 한다.
    - 테스트가 서로 의존하면 하나가 실패하면 나머지도 잇달아 실패하게 되어 원인을 찾기 어려워지며 후반 테스트가 찾아내야 할 경함이 숨겨짐.
- R (Repeatable)
    - 테스트는 어떤 환경에서도 반복 가능해야 한다.
    - 테스트가 돌아가지 않는 환경이 있다면 테스트가 실패한 이유를 둘러댈 변명이 생긴다.
- S (Self-Validating)
    - 테스트는 boolean 값으로 결과를 내야한다.
    - 성공 or 실패여야 한다.
    - 테스트가 스스로 성공과 실패를 가늠하지 않는다면 판단은 주관적이 되며 지루한 수작업 평가가 필요하게 된다.
- T (Timely)
    - 테스트는 적시에 작성해야 한다.
    - 단위 테스트는 테스트하려는 실제 코드를 구현하기 직전에 구현한다.
    - 그러지 않으면, 테스트가 불가능하도록 실제 코드를 설계할지도 모른다.