13장. 동시성
==========

## 동시성이 필요한 이유?
- 무엇과 언제를 분리하는 전략이다.
  - 서블릿 모델의 경우 웹 요청이 들어올 때마다 웹 서버는 비동기식으로 서블릿을 실행한다.
  - 각 서블릿 스레드는 다른 서블릿 스레드와 무관하게 돌아간다.
- 동시성 구현이 불가피한 경우
  - 정보 수집기의 경우 수많은 웹 사이트에서 정보를 가져오기 때문에 다중 스레드 알고리즘을 이용
  - 많은 사용자를 동시에 처리해야 하는 시스템
  - 정보를 대량으로 분석하는 시스템은 대량의 정보를 병렬로 처리하면 좋다.

## 동시성 방어 원칙

#### 단일 책임 원칙
: 동시성 코드는 다른 코드와 분리하라

#### 자료 범위를 제한하라
: 자료를 캡슐화하라, 공유 자료를 최대한 줄여라
- 공유 객체를 사용하는 코드 내 임계영역을 syncronized 키워드로 보호하는 것을 권장한다.

#### 자료 사본을 사용하라
- 객체를 복사해 읽기 전용으로 사용하는 방법을 통해 공유 자료를 줄여라

#### 스레드는 가능한 독립적으로 구현하라
- 다른 스레드와 자료를 공유하지 않는다.

## 라이브러리를 이해하라
- java.util.concurrent 패키지가 제공하는 클래스는 다중 스레드 환경에서 안전하며 성능이 좋다.
  - 동시 읽기/쓰기를 지원한다.
  - 자주 사용하는 복합 연산을 다중 스레드에서 안전하게 제공한다.

## 실행 모델을 이해하라
- 라이브락
  - 락을 거는 단계에서 각 스레드가 서로를 방해한다.

#### 생산자-소비자
- 생산자 스레드가 정보를 생성해 대기열에 넣는다.
- 소비자 스레드가 대기열에서 정보를 가져와 사용한다.
- 대기열은 한정된 자원이다.

#### 읽기-쓰기
- 읽기 스레드의 요구와 쓰기 스레드의 요구를 적절히 만족시켜 처리율도 적당히 높이고 기아도 방지해야 한다.

#### 동기화하는 메서드 사이에 존재하는 의존성을 이해하라
: 공유 객체 하나에는 메서드 하나만 사용하라
- 자바 언어는 개별 메서드를 보호하는 syncronized 개념을 지원한다.
- 공유 객체 하나에 여러 메서드가 필요한 상황도 있다.
  - 클라이언트에서 첫 번째 메서드 호출 젅에 서버를 잠그고 마지막 메서드를 호출할 때까지 잠금을 유지
  - 서버를 잠그고 모든 메서드가 호출된 후 작믕르 해제하는 메서드를 구현
  - 잠금을 수행하는 중간 단계를 생성

## 동기화하는 부분을 작게 만들어라
- syncronized를 남발하는 것은 좋지 않다.
- 임계영역은 보호해야 하며 수, 크기를 최대한 줄여야 한다.

## 올바른 종료 코드는 구현하기 어렵다.
: 검토를 꼼꼼히 해야 한다.
- 데드락
  - 모두 끝나기를 기다렸다가 자원을 해제하고 종료하는 시스템에서 자식 스레드가 하나라도 데드락에 걸리면 부모는 영원히 기다리고 시스템은 종료하지 못한다.
  - 생산자-소비자 스레드에서 생산자 스레드가 종료됐는데 소비자는 종료하라는 시그널을 못 받는다.

## 스레드 코드 테스트하기
- 테스트는 정확성을 높여줄 뿐 보장하지 않는다.
- 문제를 노출하는 테스트 케이스를 작성하라
- 프로그램 설정과 시스템 설정과 부하를 바꿔가며 자주 돌려라

#### 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라
- 일회성 문제를 계속 무시하면 잘못된 코드 위에 코드가 계속 쌓인다.

#### 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자
- 스레드 밖과 안의 버그를 동시에 디버깅하지 마라.
- 다양한 환경에 수비게 끼워 넣을 수 있게 스레드를 구현하라

#### 다중 스레드를 쓰는 코드 부분을 상황에 맞게 조율해라
- 스레드 개수를 조율하기 쉽게 구현하고 도중에 스레드 개수를 변경하는 방법도 고려한다.

#### 프로세스 수보다 많은 스레드를 돌려보라
- 스와핑이 잦을수록 임계영역을 빼먹은 코드나 데드락의 원인을 찾기 쉬워진다.

#### 여러 플랫폼에서 테스트하라

#### 코드에 강제로 실패를 일으키는 보조 코드를 넣어 테스트하라
- 아주 소수만 실패하는 버그를 발견할 수 있다.
- 보조 코드를 추가하는 방법
  - 직접 구현
    : 코드에다 직접 wait(), sleep(), yield(), priority() 함수를 추가한다.
    특별히 까다로운 코드를 테스트할 때 적합하다.
    yield를 삽입하면 실행되는 경로가 바뀐다. 버그가 있다면 원래 잘못된 코드인데 증거가 드러났을 뿐이다.
  - 자동화
    : 무작위로 실행하도록 코드를 흔들어 매번 다른 순서로 스레드를 실행하는 것을 테스트한다.
- 테스트 환경에서 보조 코드를 실행할 방법이 필요하다.
- 실행 환경에 따라 설정을 바꿔줄 방법도 필요하다.
- POJO와 스레드를 제어하는 클래스로 분할하면 추가할 위치를 찾기 쉽다.
